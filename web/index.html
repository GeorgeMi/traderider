<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TradeRider Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1rem;
            background: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            min-width: 180px;
            text-align: center;
        }
        canvas {
            display: block;
            margin: 0 auto 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        #chartStatus {
            text-align: center;
            color: red;
        }
    </style>
</head>
<body>

<h1>TradeRider Dashboard</h1>

<div class="cards">
    <div class="card"><strong>BTC Held</strong><div id="btcHeld">0</div></div>
    <div class="card"><strong>BTC Value Now</strong><div id="usdcInvested">0</div></div>
    <div class="card"><strong>Profit Realized</strong><div id="usdcProfit">0</div></div>
    <div class="card"><strong>Unrealized Profit</strong><div id="unrealized">0</div></div>
    <div class="card"><strong>Total Wallet Value</strong><div id="totalValue">0</div></div>
    <div class="card"><strong>USDC Available</strong><div id="usdcBalance">0</div></div>
    <div class="card"><strong>Total Invested</strong><div id="usdcInvestedTotal">0</div></div>
</div>

<canvas id="priceChart" width="1000" height="400"></canvas>
<p id="chartStatus" style="display: none;">No chart data available.</p>

<table>
    <thead>
    <tr>
        <th>Symbol</th><th>Side</th><th>Amount</th><th>Price</th><th>Time</th>
    </tr>
    </thead>
    <tbody id="txs"></tbody>
</table>

<script>
    let chart;

    function loadSummary() {
        fetch('/api/summary')
            .then(res => res.json())
            .then(summary => {
                document.getElementById('btcHeld').textContent = summary.btcHeld?.toFixed(4);
                document.getElementById('usdcInvested').textContent = summary.investedNow?.toFixed(2);
                document.getElementById('usdcProfit').textContent = summary.usdcProfit?.toFixed(2);
                document.getElementById('unrealized').textContent = summary.unrealized?.toFixed(2);
                document.getElementById('totalValue').textContent = summary.totalValue?.toFixed(2);
                document.getElementById('usdcBalance').textContent = summary.usdcBalance?.toFixed(2);
                document.getElementById('usdcInvestedTotal').textContent = summary.usdcInvestedTotal?.toFixed(2);
            })
            .catch(e => console.error("Failed to load summary:", e));
    }

    function loadTransactions() {
        fetch('/api/transactions')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('txs');
                tbody.innerHTML = '';
                data.forEach(tx => {
                    const row = `<tr>
                        <td>${tx.symbol}</td>
                        <td>${tx.side}</td>
                        <td>${tx.amount.toFixed(4)}</td>
                        <td>${tx.price.toFixed(2)}</td>
                        <td>${tx.time}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            })
            .catch(e => console.error("Failed to load transactions:", e));
    }

    function loadChart() {
        fetch('/api/chart-data')
            .then(res => res.json())
            .then(data => {
                const points = Array.isArray(data.points) ? data.points : [];
                const currentPrice = data.currentPrice;

                if (points.length === 0) {
                    document.getElementById("chartStatus").style.display = "block";
                    return;
                }

                document.getElementById("chartStatus").style.display = "none";

                const labels = points.map(p => p.time);
                const prices = points.map(p => p.price);
                const emaShort = points.map(p => p.emaShort ?? null);
                const emaLong = points.map(p => p.emaLong ?? null);
                const buyPoints = points.map(p => p.side === "BUY" ? p.price : null);
                const sellPoints = points.map(p => p.side === "SELL" ? p.price : null);

                const currentLine = points.map(() => currentPrice);

                const datasets = [
                    { label: 'BTC Price', data: prices, borderColor: 'blue', fill: false },
                    { label: 'EMA (5)', data: emaShort, borderColor: 'green', fill: false },
                    { label: 'EMA (20)', data: emaLong, borderColor: 'purple', fill: false },
                    {
                        label: 'BUY', data: buyPoints, backgroundColor: 'green',
                        pointRadius: 6, pointStyle: 'circle', showLine: false, spanGaps: true
                    },
                    {
                        label: 'SELL', data: sellPoints, backgroundColor: 'red',
                        pointRadius: 6, pointStyle: 'triangle', showLine: false, spanGaps: true
                    },
                    {
                        label: 'Current Price', data: currentLine, borderColor: 'black',
                        borderDash: [5, 5], fill: false, pointRadius: 0
                    }
                ];

                if (!chart) {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: { responsive: true, animation: false }
                    });
                } else {
                    chart.data.labels = labels;
                    chart.data.datasets.forEach((ds, i) => {
                        chart.data.datasets[i].data = datasets[i].data;
                    });
                    chart.update();
                }
            })
            .catch(e => console.error("Failed to load chart data:", e));
    }

    function refreshAll() {
        loadSummary();
        loadTransactions();
        loadChart();
    }

    refreshAll();
    setInterval(refreshAll, 5000);
</script>
</body>
</html>
