<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TradeRider Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1rem;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 2rem;
        }

        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .card {
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255,255,255,0.05);
            flex: 1 1 150px;
            text-align: center;
        }

        canvas {
            display: block;
            width: 100%;
            height: 400px;
            background-color: #1a1a1a;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e1e1e;
            color: #ffffff;
        }

        th, td {
            padding: 8px;
            border: 1px solid #444;
            text-align: center;
        }

        th {
            background-color: #2a2a2a;
        }

        #chartStatus {
            text-align: center;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .cards {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>

<h1>TradeRider Dashboard</h1>

<div class="cards">
    <div class="card"><strong>BTC Held</strong><div id="btcHeld">0</div></div>
    <div class="card"><strong>BTC Value Now</strong><div id="usdcInvested">0</div></div>
    <div class="card"><strong>Profit Realized</strong><div id="usdcProfit">0</div></div>
    <div class="card"><strong>Unrealized Profit</strong><div id="unrealized">0</div></div>
    <div class="card"><strong>Total Wallet Value</strong><div id="totalValue">0</div></div>
    <div class="card"><strong>USDC Available</strong><div id="usdcBalance">0</div></div>
    <div class="card"><strong>Total Invested</strong><div id="usdcInvestedTotal">0</div></div>
</div>

<canvas id="priceChart"></canvas>
<p id="chartStatus" style="display: none;">No chart data available.</p>

<table>
    <thead>
    <tr>
        <th>Symbol</th><th>Side</th><th>Amount</th><th>Price</th><th>Time</th>
    </tr>
    </thead>
    <tbody id="txs"></tbody>
</table>

<script>
    let chart;

    function loadSummary() {
        fetch('/api/summary')
            .then(res => res.json())
            .then(summary => {
                document.getElementById('btcHeld').textContent = summary.btcHeld?.toFixed(4);
                document.getElementById('usdcInvested').textContent = summary.investedNow?.toFixed(2);
                document.getElementById('usdcProfit').textContent = summary.usdcProfit?.toFixed(2);
                document.getElementById('unrealized').textContent = summary.unrealized?.toFixed(2);
                document.getElementById('totalValue').textContent = summary.totalValue?.toFixed(2);
                document.getElementById('usdcBalance').textContent = summary.usdcBalance?.toFixed(2);
                document.getElementById('usdcInvestedTotal').textContent = summary.usdcInvestedTotal?.toFixed(2);
            });
    }

    function loadTransactions() {
        fetch('/api/transactions')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('txs');
                tbody.innerHTML = '';
                data.forEach(tx => {
                    const row = `<tr>
                        <td>${tx.symbol}</td>
                        <td>${tx.side}</td>
                        <td>${tx.amount.toFixed(4)}</td>
                        <td>${tx.price.toFixed(2)}</td>
                        <td>${tx.time}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
    }

    function loadChart() {
        fetch('/api/chart-data')
            .then(res => res.json())
            .then(data => {
                const prices = data.prices || [];
                const transactions = data.transactions || [];
                const currentPrice = data.currentPrice;

                if (prices.length === 0) {
                    document.getElementById("chartStatus").style.display = "block";
                    return;
                }
                document.getElementById("chartStatus").style.display = "none";

                const priceData = prices.map(p => ({ x: p.time, y: p.price }));
                const currentLine = prices.map(p => ({ x: p.time, y: currentPrice }));

                const buyPoints = transactions
                    .filter(tx => tx.side === "BUY")
                    .map(tx => ({ x: tx.time, y: tx.price, amount: tx.amount }));

                const sellPoints = transactions
                    .filter(tx => tx.side === "SELL")
                    .map(tx => ({ x: tx.time, y: tx.price, amount: tx.amount }));

                const datasets = [
                    {
                        label: 'BTC Price',
                        data: priceData,
                        borderColor: 'deepskyblue',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'BUY',
                        type: 'scatter',
                        data: buyPoints,
                        backgroundColor: 'lime',
                        pointRadius: 5,
                        pointStyle: 'circle'
                    },
                    {
                        label: 'SELL',
                        type: 'scatter',
                        data: sellPoints,
                        backgroundColor: 'tomato',
                        pointRadius: 5,
                        pointStyle: 'triangle'
                    },
                    {
                        label: 'Current Price',
                        data: currentLine,
                        borderColor: 'gray',
                        borderDash: [4, 4],
                        fill: false,
                        pointRadius: 0,
                        borderWidth: 1
                    }
                ];

                const options = {
                    responsive: true,
                    animation: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const point = context.raw;
                                    if (point && point.amount !== undefined) {
                                        return `${context.dataset.label}: ${point.y.toFixed(2)} USD, ${point.amount.toFixed(6)} BTC`;
                                    }
                                    return `${context.dataset.label}: ${point.y.toFixed(2)} USD`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'HH:mm:ss',
                                displayFormats: {
                                    second: 'HH:mm:ss',
                                    minute: 'HH:mm'
                                }
                            },
                            ticks: {
                                color: '#aaa',
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            ticks: { color: '#aaa' }
                        }
                    }
                };

                if (!chart) {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: priceData.map(p => p.x),
                            datasets
                        },
                        options
                    });
                } else {
                    chart.data.labels = priceData.map(p => p.x);
                    chart.data.datasets.forEach((ds, i) => {
                        ds.data = datasets[i].data;
                    });
                    chart.update();
                }
            });
    }

    function refreshAll() {
        loadSummary();
        loadTransactions();
        loadChart();
    }

    refreshAll();
    setInterval(refreshAll, 5000);
</script>

</body>
</html>
